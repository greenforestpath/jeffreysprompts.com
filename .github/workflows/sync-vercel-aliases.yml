name: Sync Vercel Aliases

# This workflow ensures all production subdomains point to the same deployment.
# Without this, pro.jeffreysprompts.com can become stale and show broken CSS.

on:
  # Run after CI completes on main (gives Vercel time to deploy)
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

  # Also allow manual trigger for emergency fixes
  workflow_dispatch:

  # Run on a schedule to catch any drift
  schedule:
    # Every 6 hours
    - cron: '0 */6 * * *'

jobs:
  sync-aliases:
    name: Sync Production Aliases
    runs-on: ubuntu-latest
    env:
      BUN_VERSION: "1.2"
    # Only run if CI succeeded (or manual/scheduled trigger)
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    timeout-minutes: 5

    steps:
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Ensure Vercel token configured
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          if [ -z "${VERCEL_TOKEN:-}" ]; then
            echo "::error::Missing VERCEL_TOKEN secret. Alias sync cannot run without it."
            echo "::error::Add VERCEL_TOKEN in repo secrets (Vercel > Account Tokens)."
            exit 1
          fi

      - name: Wait for Vercel deployment
        # Give Vercel time to complete the deployment after CI
        if: github.event_name == 'workflow_run'
        run: sleep 120

      - name: Get production deployment URL
        id: get-prod
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          # Get the current production deployment for jeffreysprompts.com
          # The inspect output contains a line like: "url    https://jeffreysprompts-xxx.vercel.app"
          PROD_INFO=$(bunx vercel inspect jeffreysprompts.com --token "$VERCEL_TOKEN" --scope dicklesworthstones-projects 2>&1 || true)

          # Extract URL - try multiple patterns for robustness
          PROD_URL=$(echo "$PROD_INFO" | grep -E 'url\s+https://' | head -1 | awk '{print $2}' | sed 's|https://||')

          if [ -z "$PROD_URL" ]; then
            echo "::error::Could not determine production URL from vercel inspect"
            echo "Inspect output was:"
            echo "$PROD_INFO"
            exit 1
          fi

          echo "prod_url=$PROD_URL" >> "$GITHUB_OUTPUT"
          echo "Production URL: $PROD_URL"

      - name: Get pro alias deployment URL
        id: get-pro
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          PRO_INFO=$(bunx vercel inspect pro.jeffreysprompts.com --token "$VERCEL_TOKEN" --scope dicklesworthstones-projects 2>&1 || true)
          PRO_URL=$(echo "$PRO_INFO" | grep -E 'url\s+https://' | head -1 | awk '{print $2}' | sed 's|https://||')
          if [ -z "$PRO_URL" ]; then
            echo "::warning::Could not determine pro alias target from vercel inspect"
          else
            echo "Pro alias URL: $PRO_URL"
          fi
          echo "pro_url=$PRO_URL" >> "$GITHUB_OUTPUT"

      - name: Check alias target alignment
        id: check-alias
        run: |
          PROD_URL="${{ steps.get-prod.outputs.prod_url }}"
          PRO_URL="${{ steps.get-pro.outputs.pro_url }}"

          if [ -z "$PRO_URL" ]; then
            echo "aligned=false" >> "$GITHUB_OUTPUT"
            echo "reason=pro_url_missing" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$PROD_URL" = "$PRO_URL" ]; then
            echo "aligned=true" >> "$GITHUB_OUTPUT"
            echo "reason=alias_match" >> "$GITHUB_OUTPUT"
          else
            echo "aligned=false" >> "$GITHUB_OUTPUT"
            echo "reason=alias_mismatch" >> "$GITHUB_OUTPUT"
            echo "::warning::Alias mismatch: pro -> $PRO_URL (expected $PROD_URL)"
          fi

      - name: Check CSS chunk alignment
        id: check-css
        run: |
          # Get CSS chunks from both domains
          MAIN_CSS=$(curl -sf "https://jeffreysprompts.com" | grep -oE '/_next/static/chunks/[^"]+\.css' | sort -u | head -5)
          PRO_CSS=$(curl -sf "https://pro.jeffreysprompts.com" | grep -oE '/_next/static/chunks/[^"]+\.css' | sort -u | head -5)

          ALIAS_ALIGNED="${{ steps.check-alias.outputs.aligned }}"

          echo "Main site CSS chunks:"
          echo "$MAIN_CSS"
          echo ""
          echo "Pro site CSS chunks:"
          echo "$PRO_CSS"

          # Validate we actually got CSS chunks (not empty due to site being down)
          if [ -z "$MAIN_CSS" ]; then
            echo "::error::Could not extract CSS chunks from main site - site may be down"
            exit 1
          fi

          if [ -z "$PRO_CSS" ]; then
            echo "::warning::Could not extract CSS chunks from pro site - may need re-aliasing"
            echo "css_aligned=false" >> "$GITHUB_OUTPUT"
          elif [ "$MAIN_CSS" = "$PRO_CSS" ]; then
            echo "css_aligned=true" >> "$GITHUB_OUTPUT"
            echo "::notice::CSS chunks are aligned - no action needed"
          else
            echo "css_aligned=false" >> "$GITHUB_OUTPUT"
            echo "::warning::CSS chunks differ - will re-alias pro subdomain"
          fi

          # Final decision: alias must match AND CSS must match
          if [ "$ALIAS_ALIGNED" = "true" ] && [ "$PRO_CSS" = "$MAIN_CSS" ]; then
            echo "aligned=true" >> "$GITHUB_OUTPUT"
          else
            echo "aligned=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Sync pro subdomain alias
        if: steps.check-css.outputs.aligned == 'false'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          PROD_URL="${{ steps.get-prod.outputs.prod_url }}"
          echo "Aliasing $PROD_URL to pro.jeffreysprompts.com..."

          bunx vercel alias set "$PROD_URL" pro.jeffreysprompts.com \
            --token "$VERCEL_TOKEN" \
            --scope dicklesworthstones-projects

          echo "::notice::Successfully synced pro.jeffreysprompts.com to $PROD_URL"

      - name: Verify sync
        if: steps.check-css.outputs.aligned == 'false'
        run: |
          # Wait for CDN propagation
          sleep 15

          # Verify alias target matches prod
          PROD_URL="${{ steps.get-prod.outputs.prod_url }}"
          PRO_INFO=$(bunx vercel inspect pro.jeffreysprompts.com --scope dicklesworthstones-projects 2>&1 || true)
          PRO_URL=$(echo "$PRO_INFO" | grep -E 'url\s+https://' | head -1 | awk '{print $2}' | sed 's|https://||')
          if [ -n "$PRO_URL" ] && [ "$PRO_URL" != "$PROD_URL" ]; then
            echo "::error::Alias verification failed - pro still points to $PRO_URL (expected $PROD_URL)"
            exit 1
          fi

          # Verify CSS chunks now match
          MAIN_CSS=$(curl -sf "https://jeffreysprompts.com" | grep -oE '/_next/static/chunks/[^"]+\.css' | sort -u | head -5)
          PRO_CSS=$(curl -sf "https://pro.jeffreysprompts.com" | grep -oE '/_next/static/chunks/[^"]+\.css' | sort -u | head -5)

          if [ -z "$MAIN_CSS" ] || [ -z "$PRO_CSS" ]; then
            echo "::warning::Could not verify - one or both sites returned no CSS chunks"
            echo "Main: $MAIN_CSS"
            echo "Pro: $PRO_CSS"
            # Don't fail - the alias was set, CDN might just be slow
            exit 0
          fi

          if [ "$MAIN_CSS" = "$PRO_CSS" ]; then
            echo "::notice::Verification passed - CSS chunks now match"
          else
            echo "::error::Verification failed - CSS chunks still differ after alias update"
            echo "Main: $MAIN_CSS"
            echo "Pro: $PRO_CSS"
            exit 1
          fi
